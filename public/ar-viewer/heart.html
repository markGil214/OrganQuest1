<!doctype html>
<html>

	<head>
		<meta name='viewport' content='width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0'>
		<script src="vendor/three.101.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/three@0.101.1/examples/js/loaders/GLTFLoader.js"></script>
		<script src="THREEAR.js"></script>
		<title>AR Heart Explorer - Kids Anatomy</title>
		<style>
			body {
				margin: 0px;
				overflow: hidden;
				font-family: 'Comic Sans MS', cursive, Arial, sans-serif;
				background: linear-gradient(45deg, #ff9a9e, #fecfef, #fecfef, #ff9a9e);
				background-size: 400% 400%;
				animation: gradientShift 8s ease infinite;
			}
			
			@keyframes gradientShift {
				0% { background-position: 0% 50%; }
				50% { background-position: 100% 50%; }
				100% { background-position: 0% 50%; }
			}
			
			.ar-ui {
				position: absolute;
				top: 15px;
				left: 15px;
				z-index: 100;
				background: linear-gradient(135deg, #ff6b9d, #c44569);
				padding: 12px 15px;
				border-radius: 20px;
				box-shadow: 0 6px 20px rgba(255, 107, 157, 0.3);
				max-width: 200px;
				border: 3px solid #fff;
				animation: float 3s ease-in-out infinite;
			}
			
			@keyframes float {
				0%, 100% { transform: translateY(0px); }
				50% { transform: translateY(-3px); }
			}
			
			.ar-title {
				color: #fff;
				font-size: 1.1rem;
				font-weight: bold;
				margin: 0 0 8px 0;
				text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
				text-align: center;
				letter-spacing: 0.5px;
			}
			
			.ar-instructions {
				color: #fff;
				font-size: 0.7rem;
				margin: 0 0 10px 0;
				line-height: 1.3;
				text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
				text-align: center;
			}
			
			.button-container {
				display: flex;
				gap: 8px;
				justify-content: center;
			}
			
			.ar-back-btn {
				background: linear-gradient(135deg, #ffd700, #ffb347);
				color: #333;
				border: none;
				padding: 8px 12px;
				border-radius: 15px;
				font-weight: bold;
				cursor: pointer;
				font-size: 0.7rem;
				box-shadow: 0 3px 10px rgba(255, 215, 0, 0.3);
				transition: all 0.3s ease;
				border: 2px solid #fff;
				font-family: 'Comic Sans MS', cursive;
				flex: 1;
			}
			
			.ar-back-btn:hover {
				background: linear-gradient(135deg, #ffb347, #ffd700);
				transform: translateY(-2px) scale(1.02);
			}
			
			.interactive-btn {
				background: linear-gradient(135deg, #4ecdc4, #44a08d);
				color: #fff;
				border: none;
				padding: 8px 12px;
				border-radius: 15px;
				font-weight: bold;
				cursor: pointer;
				font-size: 0.7rem;
				box-shadow: 0 3px 10px rgba(78, 205, 196, 0.3);
				transition: all 0.3s ease;
				border: 2px solid #fff;
				font-family: 'Comic Sans MS', cursive;
				flex: 1;
			}
			
			.interactive-btn:hover {
				background: linear-gradient(135deg, #44a08d, #4ecdc4);
				transform: translateY(-2px) scale(1.02);
			}
			
			.zoom-controls {
				position: absolute;
				bottom: 120px;
				right: 20px;
				z-index: 100;
				display: flex;
				flex-direction: column;
				gap: 15px;
			}
			
			.zoom-btn {
				background: linear-gradient(135deg, #ff6b9d, #c44569);
				border: 4px solid #fff;
				color: #fff;
				width: 60px;
				height: 60px;
				border-radius: 50%;
				font-size: 2rem;
				font-weight: bold;
				cursor: pointer;
				display: flex;
				align-items: center;
				justify-content: center;
				box-shadow: 0 6px 20px rgba(255, 107, 157, 0.4);
				transition: all 0.3s ease;
				font-family: 'Comic Sans MS', cursive;
			}
			
			.zoom-btn:hover {
				background: linear-gradient(135deg, #c44569, #ff6b9d);
				transform: scale(1.15) rotate(5deg);
				box-shadow: 0 8px 25px rgba(255, 107, 157, 0.6);
			}
			
			.zoom-btn:active {
				transform: scale(0.95);
			}
			
			.zoom-info {
				position: absolute;
				bottom: 140px;
				right: 90px;
				background: linear-gradient(135deg, #ffd700, #ffb347);
				padding: 10px 15px;
				border-radius: 15px;
				font-size: 0.9rem;
				color: #333;
				z-index: 100;
				min-width: 70px;
				text-align: center;
				border: 3px solid #fff;
				box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
				font-weight: bold;
				font-family: 'Comic Sans MS', cursive;
			}
			
			.heart-info {
				position: absolute;
				bottom: 15px;
				left: 15px;
				right: 15px;
				background: linear-gradient(135deg, #ff6b9d, #c44569);
				color: white;
				padding: 10px 15px;
				border-radius: 20px;
				text-align: center;
				z-index: 100;
				border: 3px solid #fff;
				box-shadow: 0 4px 15px rgba(255, 107, 157, 0.3);
				animation: heartBeat 2s ease-in-out infinite;
			}
			
			@keyframes heartBeat {
				0%, 100% { transform: scale(1); }
				25% { transform: scale(1.02); }
				75% { transform: scale(1.01); }
			}
			
			.heart-fact {
				font-size: 0.8rem;
				font-weight: bold;
				margin: 0;
				text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
				font-family: 'Comic Sans MS', cursive;
			}
			
			.zoom-hint {
				position: absolute;
				top: 40%;
				left: 50%;
				transform: translate(-50%, -50%);
				background: linear-gradient(135deg, #4ecdc4, #44a08d);
				color: white;
				padding: 12px 16px;
				border-radius: 15px;
				font-size: 0.8rem;
				font-weight: bold;
				z-index: 150;
				animation: pulse-hint 2s infinite;
				pointer-events: none;
				border: 3px solid #fff;
				box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
				font-family: 'Comic Sans MS', cursive;
				text-align: center;
				max-width: 180px;
			}
			
			@keyframes pulse-hint {
				0% { opacity: 0.8; transform: translate(-50%, -50%) scale(1); }
				50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
				100% { opacity: 0.8; transform: translate(-50%, -50%) scale(1); }
			}
			
			/* Fun stars decoration */
			.star {
				position: absolute;
				color: #ffd700;
				font-size: 1.5rem;
				animation: twinkle 2s ease-in-out infinite;
				z-index: 99;
			}
			
			@keyframes twinkle {
				0%, 100% { opacity: 0.3; transform: scale(1); }
				50% { opacity: 1; transform: scale(1.2); }
			}
			
			.star:nth-child(1) { top: 10%; left: 10%; animation-delay: 0s; }
			.star:nth-child(2) { top: 20%; right: 15%; animation-delay: 0.5s; }
			.star:nth-child(3) { bottom: 30%; left: 5%; animation-delay: 1s; }
			.star:nth-child(4) { bottom: 15%; right: 10%; animation-delay: 1.5s; }
			
			/* Mobile responsive adjustments */
			@media (max-width: 768px) {
				.ar-ui {
					max-width: 180px;
					padding: 10px 12px;
					top: 10px;
					left: 10px;
				}
				
				.ar-title {
					font-size: 0.9rem;
				}
				
				.ar-instructions {
					font-size: 0.6rem;
					margin-bottom: 8px;
				}
				
				.ar-back-btn, .interactive-btn {
					padding: 6px 8px;
					font-size: 0.6rem;
				}
				
				.zoom-btn {
					width: 45px;
					height: 45px;
					font-size: 1.5rem;
				}
				
				.heart-fact {
					font-size: 0.7rem;
				}
				
				.zoom-hint {
					font-size: 0.7rem;
					padding: 10px 12px;
					max-width: 150px;
				}
				
				.heart-info {
					padding: 8px 12px;
					bottom: 10px;
					left: 10px;
					right: 10px;
				}
			}
		</style>
	</head>

	<body>
		<!-- Fun decorative stars -->
		<div class="star">‚≠ê</div>
		<div class="star">‚ú®</div>
		<div class="star">üí´</div>
		<div class="star">üåü</div>
		
		<!-- AR UI Overlay -->
		<div class="ar-ui">
			<h1 class="ar-title">‚ù§Ô∏è Heart Explorer</h1>
			<p class="ar-instructions">
				üì± Point camera at marker to see 3D heart!
			</p>
			<div class="button-container">
				<button class="ar-back-btn" onclick="window.history.back()">üîô Back</button>
				<button class="interactive-btn" onclick="openInteractiveHeart()">üîç Explore</button>
			</div>
		</div>
		
		<!-- Heart Info -->
		<div class="heart-info">
			<p class="heart-fact">ÔøΩ Your heart beats 100,000 times daily! ÔøΩ</p>
		</div>
		
		<!-- Zoom Hint -->
		<div class="zoom-hint" id="zoomHint" style="display: none;">
			üîç Zoom all the way in to explore inside!
		</div>
		
		<!-- Zoom Controls -->
		<div class="zoom-controls">
			<button class="zoom-btn" onclick="zoomIn()">‚ûï</button>
			<button class="zoom-btn" onclick="zoomOut()">‚ûñ</button>
		</div>
		<div class="zoom-info" id="zoomInfo">100% üíó</div>

		<script>
		var renderer = new THREE.WebGLRenderer({
			alpha: true,
			antialias: true
		});
		renderer.setClearColor(new THREE.Color('lightgrey'), 0);
		renderer.setSize(window.innerWidth, window.innerHeight);
		renderer.domElement.style.position = 'absolute';
		renderer.domElement.style.top = '0px';
		renderer.domElement.style.left = '0px';
		document.body.appendChild(renderer.domElement);
	
		var scene = new THREE.Scene();
		var camera = new THREE.Camera();
		scene.add(camera);

	var heartGroup = new THREE.Group();
	scene.add(heartGroup);
	
	// Zoom variables
	var currentZoom = 1.0;
	var minZoom = 0.5;
	var maxZoom = 3.0;
	var zoomStep = 0.2;
	
	// Zoom functions
	function zoomIn() {
		if (currentZoom < maxZoom) {
			currentZoom += zoomStep;
			updateZoom();
			
			// Auto-redirect to interactive view when reaching maximum zoom
			if (currentZoom >= maxZoom) {
				setTimeout(function() {
					openInteractiveHeart();
				}, 500); // Small delay for smooth transition
			}
		}
	}
	
	function zoomOut() {
		if (currentZoom > minZoom) {
			currentZoom -= zoomStep;
			updateZoom();
		}
	}
	
	function updateZoom() {
		// Apply zoom to the heart group
		heartGroup.userData.zoomScale = currentZoom;
		document.getElementById('zoomInfo').textContent = Math.round(currentZoom * 100) + '% üíó';
		
		// Show visual feedback when approaching max zoom
		if (currentZoom >= maxZoom * 0.9) {
			document.getElementById('zoomInfo').style.background = 'linear-gradient(135deg, #4ecdc4, #44a08d)';
			document.getElementById('zoomInfo').style.color = 'white';
			// Show zoom hint
			document.getElementById('zoomHint').style.display = 'block';
		} else {
			document.getElementById('zoomInfo').style.background = 'linear-gradient(135deg, #ffd700, #ffb347)';
			document.getElementById('zoomInfo').style.color = '#333';
			// Hide zoom hint
			document.getElementById('zoomHint').style.display = 'none';
		}
	}
	
	// Function to open interactive heart viewer
	function openInteractiveHeart() {
		window.location.href = 'heart-interactive.html?zoom=close';
	}

	var source = new THREEAR.Source({ renderer, camera });

	THREEAR.initialize({ source: source }).then((controller) => {
		// Load 3D Heart Model
		var loader = new THREE.GLTFLoader();
		loader.load('../models/heart3D/scene.gltf', function(gltf) {
			var heartModel = gltf.scene;
			
			// Scale the heart model to appropriate size for AR
			heartModel.scale.set(0.5, 0.5, 0.5);
			heartModel.position.y = 0.5;
			
				// Make the model lighter/brighter with cartoon-like red tint
				heartModel.traverse(function(child) {
					if (child.isMesh) {
						if (child.material) {
							// Make materials more cartoon-like and lighter (from HeartViewer)
							child.material.metalness = 0; // No metallic look
							child.material.roughness = 1; // Completely matte
							
							// Make the heart a pleasant pink/red color
							if (child.material.color) {
								child.material.color.setHex(0xff6b9d); // Bright pink/red
							}
							
							// Add slight emissive glow for cartoon effect
							if (child.material.emissive) {
								child.material.emissive.setHex(0xff1744);
								child.material.emissiveIntensity = 0.1;
							} else {
								// Add red glow for heart activity
								child.material.emissive = new THREE.Color(0xff1744);
								child.material.emissiveIntensity = 0.1;
							}
							
							// If it has a color property, make it brighter
							if (child.material.color) {
								child.material.color.multiplyScalar(1.5);
							}
						}
					}
				});			// Add the heart model to the group
			heartGroup.add(heartModel);
			
			// Initialize zoom scale
			heartGroup.userData.zoomScale = currentZoom;
			
			// Add heart activity animation to the model
			var originalScale = { x: 0.5, y: 0.5, z: 0.5 };
			var time = 0;
			
			// Animation loop for beating heart
			function animateHeart() {
				time += 0.016; // 60fps
				var heartbeatScale = 1 + Math.sin(time * 4) * 0.1; // Heart beating
				
				// Apply both zoom and heartbeat animation
				var zoomScale = heartGroup.userData.zoomScale || 1.0;
				heartModel.scale.set(
					originalScale.x * heartbeatScale * zoomScale,
					originalScale.y * heartbeatScale * zoomScale,
					originalScale.z * heartbeatScale * zoomScale
				);
				heartModel.rotation.y += 0.005; // Slow rotation
			}
			
			// Start the animation
			var animationId;
			function animate() {
				animationId = requestAnimationFrame(animate);
				animateHeart();
				
				controller.update(source.domElement);
				renderer.render(scene, camera);
			}
			animate();
			
		}, function(progress) {
			console.log('Loading heart model...', (progress.loaded / progress.total * 100) + '%');
		}, function(error) {
			console.error('Error loading heart model:', error);
			// Fallback to simple geometry if model fails to load
			createSimpleHeart();
		});

		// Fallback function to create simple heart if GLTF fails
		function createSimpleHeart() {
			// Create heart geometry (sphere with bumpy surface for heart-like texture)
			var heartGeometry = new THREE.SphereGeometry(0.4, 32, 32);
			
			// Create heart material with HeartViewer cartoon-style color
			var heartMaterial = new THREE.MeshPhongMaterial({ 
				color: 0xff6b9d, // Bright pink/red like HeartViewer
				shininess: 30,
				transparent: true,
				opacity: 0.9,
				metalness: 0, // No metallic look
				roughness: 1, // Completely matte
				emissive: new THREE.Color(0xff1744),
				emissiveIntensity: 0.1
			});
			
			var heart = new THREE.Mesh(heartGeometry, heartMaterial);
			heart.position.y = 0.5;
			heartGroup.add(heart);
			
			// Add simple animation for fallback heart
			var time = 0;
			function animateFallbackHeart() {
				requestAnimationFrame(animateFallbackHeart);
				time += 0.016;
				
				// Heart gentle beating
				var pulseScale = 1 + Math.sin(time * 4) * 0.1;
				var zoomScale = heartGroup.userData.zoomScale || 1.0;
				heart.scale.set(
					pulseScale * zoomScale,
					pulseScale * zoomScale,
					pulseScale * zoomScale
				);
				heart.rotation.y += 0.002;
				
				controller.update(source.domElement);
				renderer.render(scene, camera);
			}
			animateFallbackHeart();
		}

		// Add lighting for better heart appearance (HeartViewer style)
		// Bright ambient light for cartoon-like appearance
		var ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
		scene.add(ambientLight);
		
		// Soft main directional light
		var directionalLight = new THREE.DirectionalLight(0xffffff, 0.6);
		directionalLight.position.set(5, 5, 5);
		directionalLight.castShadow = false; // Disable shadows for lighter look
		scene.add(directionalLight);
		
		// Colorful fill lights for playful appearance
		var fillLight1 = new THREE.DirectionalLight(0xff6b9d, 0.3);
		fillLight1.position.set(-5, 0, -5);
		scene.add(fillLight1);
		
		var fillLight2 = new THREE.DirectionalLight(0x6bb6ff, 0.3);
		fillLight2.position.set(5, 0, -5);
		scene.add(fillLight2);
		
		// Top light for even illumination
		var topLight = new THREE.DirectionalLight(0xffffff, 0.4);
		topLight.position.set(0, 10, 0);
		scene.add(topLight);
		
		// Add additional soft lighting for better visibility
		var hemisphereLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
		scene.add(hemisphereLight);

		// Create pattern marker for tracking
		var patternMarker = new THREEAR.PatternMarker({
			patternUrl: 'data/patt.hiro',
			markerObject: heartGroup
		});

		controller.trackMarker(patternMarker);

		// Touch gesture support for pinch-to-zoom
		var initialDistance = 0;
		var initialZoom = currentZoom;
		
		function getDistance(touches) {
			var dx = touches[0].clientX - touches[1].clientX;
			var dy = touches[0].clientY - touches[1].clientY;
			return Math.sqrt(dx * dx + dy * dy);
		}
		
		document.addEventListener('touchstart', function(e) {
			if (e.touches.length === 2) {
				e.preventDefault();
				initialDistance = getDistance(e.touches);
				initialZoom = currentZoom;
			}
		});
		
		document.addEventListener('touchmove', function(e) {
			if (e.touches.length === 2) {
				e.preventDefault();
				var currentDistance = getDistance(e.touches);
				var scaleFactor = currentDistance / initialDistance;
				var newZoom = initialZoom * scaleFactor;
				
				// Clamp zoom within limits
				newZoom = Math.max(minZoom, Math.min(maxZoom, newZoom));
				currentZoom = newZoom;
				updateZoom();
				
				// Auto-redirect to interactive view when reaching maximum zoom via touch
				if (currentZoom >= maxZoom) {
					setTimeout(function() {
						openInteractiveHeart();
					}, 500);
				}
			}
		});
		
		// Mouse wheel zoom for desktop
		document.addEventListener('wheel', function(e) {
			e.preventDefault();
			if (e.deltaY < 0) {
				zoomIn();
			} else {
				zoomOut();
			}
		});

		// Handle window resize
		window.addEventListener('resize', function() {
			renderer.setSize(window.innerWidth, window.innerHeight);
		});

	}).catch((error) => {
		console.error('THREEAR initialization failed:', error);
		alert('AR initialization failed. Please make sure you have a camera and try again.');
	});		</script>
	</body>
	
</html>
